{{'grid.css' |  asset_url | stylesheet_tag}}

<p class="section_title">Tisso vison in the wild</p>

<div class="grid">
    {% for product in section.settings.product_list %}
      <div class="product" data-image = "{{ product.featured_image|img_url:"600x600" }}" data-title="{{ product.title }}" data-price="{{ product.price | money }}" data-description= "{{ product.description }}" 
        data-options= "{{ product.options_with_values | json | escape}}" data-variants="{{ product.variants | json | escape }}">
        <img src="{{ product.featured_image| img_url: '480x480' }}" alt="{{ product.title }}" width="600rem" height="600rem">
        

      </div>
    {% endfor %}
</div>

<div id="modal" class="modal">
    <span id="modalCloseButton" class="modal_close_button">
      &#10006;
    </span>
  <div class="modal_content">
    <div class="modal_img_container">
      <img id="modalImage" class="modal_img" src="{{ product.featured_image| img_url: '480x480' }}" alt="{{ product.title }}" width="100px" height="100px">
    </div>
    <div class="modal_text">
      <p id="modalTitle" class="modal_title"> product title </p>
      <p id="modalPrice" class="modal_price"> Product Price </p>
      <p id="modalDescription" class="modal_description"> Product description </p>
    </div> 
  </div>


  <p class="color_div_title"> Color </p>
  <div id="modalColors" class="modal_color_selection">
    
  </div>
      <p class="size_div_title"> Size </p>

  <div id="modalSizes" class="modal_size_selection">
  </div>

  <form id="addToCartForm" action="/cart/add" method="post">
    <input type="hidden" id="variantIdInput" name="id" value="">
    <input type="hidden" id="quantityInput" name="quantity" value="1">
    <button type="submit" class="add_to_cart_button"> ADD TO CART &#8594; </button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded',()=>{
    
    const modal = document.getElementById('modal');
    const modalCloseButton=document.getElementById('modalCloseButton');
    const addToCartForm = document.getElementById('addToCartForm');
    const quantityInput = document.getElementById('quantityInput');
    const variantIdInput= document.getElementById('variantIdInput')
    let selectedColor=null;
    let selectedSize = null;
    
    document.querySelectorAll('.product').forEach((product) =>{
      product.addEventListener('click',(e) =>{
        const productData= e.currentTarget.dataset;
        const variants= JSON.parse(productData.variants);
        console.log(variants);
        document.getElementById('modalImage').src=productData.image;
        document.getElementById('modalTitle').innerText=productData.title;
        document.getElementById('modalPrice').innerText=productData.price;
        document.getElementById('modalDescription').innerHTML=productData.description;
        

        
        const options=JSON.parse(productData.options);
        const sizeOption=options[0];
        const colorOption=options[1];
        modalColors.innerHTML = '';
        modalSizes.innerHTML = '';
        
        if(colorOption){
          colorOption.values.forEach((color) =>{
            const colorChoice = document.createElement('div');
            colorChoice.classList.add('color_choice');
  
            const colorShowcase=document.createElement('span');
            const colorName=document.createElement('span');
            colorShowcase.classList.add('color_showcase');
            colorName.classList.add('color_name');
            colorShowcase.style.backgroundColor=color;
            colorName.innerHTML='<p>'+color+'</p>';
            colorChoice.appendChild(colorShowcase);  
            colorChoice.appendChild(colorName);
            modalColors.appendChild(colorChoice);

            colorChoice.addEventListener('click', () => {
            document.querySelectorAll('.color_choice').forEach(el => {
              el.querySelector('.color_name').style.backgroundColor = 'white';
              el.querySelector('.color_name').style.color = 'black';
            });
            colorName.style.backgroundColor = 'black'; 
            colorName.style.color = 'white';
            selectedColor = color;
            console.log(selectedColor);
          });
        });
          
        }

        if (sizeOption) {
        const sizeSelect = document.createElement('select'); 
        sizeOption.values.forEach((size) => {
          const sizeOptionElement = document.createElement('option');
          sizeSelect.classList.add('size_select');
          sizeOptionElement.classList.add('size_option_element')
          sizeOptionElement.value = size;
          sizeOptionElement.innerText = size;
          sizeSelect.appendChild(sizeOptionElement);
        });
        modalSizes.appendChild(sizeSelect); 

        sizeSelect.addEventListener('change', () => {
          selectedSize = sizeSelect.value;
          
        });
      }


        modal.style.display='block';
      });
    });
    modalCloseButton.addEventListener('click', ()=>{
      modal.style.display='none';
    })
    addToCartForm.addEventListener('submit', (e) => {
      e.preventDefault();
      console.log(selectedColor +' ' + selectedSize);
      const selectedVariant =variants.find(variant => {
        const includesColor = variant.options.includes(selectedColor);
        const includesSize = variant.options.includes(selectedSize);
        return includesColor && includesSize;
      });
      if(!selectedVariant){
        alert('Fill missing options first.');
        return;
        
      }
      console.log(selectedVariant);
      variantIdInput.value=selectedVariant.id;
      const formData = new FormData();
      formData.append('id', selectedVariant.id);
      formData.append('qunatity', quantityInput.value);

      fetch('/cart/add.js',{
        method : 'POST',
        body : 'formData'
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        alert('Product added to cart!');
      })
      .catch((error) => {
        console.error('Error adding product to cart:', error);
        alert('Failed to add product to cart');
      });
      
    })
    
  })
  
</script>

{% schema %}
  {
    "name": "grid",
    "settings": [
      {
        "type": "product_list",
        "id": "product_list",
        "label": "Select the Products to be featured",
        "limit": 6
        
      }
    ]
  }
{% endschema %}